<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package
    Name="IPPopper"
    Manufacturer="Cantankerous Contraption Co."
    Version="1.42.6.0"
    UpgradeCode="3F5C7E1A-6B2B-4C7A-A7D9-3C2B17B4B3D0">

    <SummaryInformation Keywords="Installer" Description="IPPopper - IP Address System Tray Utility" />

    <MajorUpgrade DowngradeErrorMessage="!(loc.DowngradeError)" />
    <MediaTemplate EmbedCab="yes" />

    <Property Id="ARPPRODUCTICON" Value="IPPopperIcon" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/dpo007/IPPopper" />

    <!-- Detect legacy (non-MSI) installs so we can clean them up on first MSI install -->
    <Property Id="LEGACY_IPPOPPER_RUN_VALUE">
      <RegistrySearch
        Root="HKLM"
        Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
        Name="IPPopper"
        Type="raw" />
    </Property>

    <Property Id="LEGACY_IPPOPPER_EXE">
      <DirectorySearch Id="LegacyInstallDirSearch" Path="C:\IPPopper">
        <FileSearch Id="LegacyExeSearch" Name="IPPopper.exe" />
      </DirectorySearch>
    </Property>

    <Property Id="LEGACY_IPPOPPER_SHORTCUT">
      <DirectorySearch Id="LegacyStartMenuProgramsSearch" Path="[CommonStartMenuFolder]Programs">
        <FileSearch Id="LegacyShortcutSearch" Name="IPPopper.lnk" />
      </DirectorySearch>
    </Property>

    <!-- Embed VBScript for legacy cleanup -->
    <Binary Id="CleanupLegacyScript" SourceFile="CleanupLegacy.vbs" />

    <!-- VBScript custom action for legacy cleanup -->
    <CustomAction
      Id="CA_CleanupLegacyInstall"
      BinaryRef="CleanupLegacyScript"
      Execute="immediate"
      Return="ignore"
      Impersonate="no"
      VBScriptCall="Call Main()" />

    <InstallExecuteSequence>
      <!-- Run cleanup early during install, after CreateFolders -->
      <Custom
        Action="CA_CleanupLegacyInstall"
        After="CreateFolders"
        Condition="NOT Installed AND (LEGACY_IPPOPPER_RUN_VALUE OR LEGACY_IPPOPPER_EXE OR LEGACY_IPPOPPER_SHORTCUT)" />
    </InstallExecuteSequence>

    <Feature Id="Main" Title="IPPopper" Level="1">
      <ComponentGroupRef Id="IPPopperFiles" />
      <ComponentGroupRef Id="IPPopperShortcuts" />
      <ComponentGroupRef Id="IPPopperStartup" />
    </Feature>
  </Package>
</Wix>
